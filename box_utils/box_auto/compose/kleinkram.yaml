x-common-config: &common-config
  build:
    context: "$HOME/git/grand_tour_box/box_utils/box_auto/docker"
    dockerfile: "$HOME/git/grand_tour_box/box_utils/box_auto/docker/box.Dockerfile"
    ssh:
      default: "$HOME/.ssh/id_rsa_2"
  image: rslethz/grand_tour_box:kleinkram
  runtime: nvidia
  # network_mode: host
  privileged: true
  environment:
    QT_X11_NO_MITSHM: "1"
    XAUTHORITY: "/root/.docker.xauth"
    DISPLAY: "$DISPLAY"  
    KLEINKRAM_ACTIVE: "False"  # Added this line
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities:
              - gpu
              - utility # nvidia-smi
              - compute # CUDA
              - video   # encoding 
  volumes:
    - "${MISSION_DATA:-/mission/data}:/mission_data"
    - "${GRAND_TOUR_BOX_PATH:-$HOME/git/grand_tour_box}:/home/catkin_ws/src/grand_tour_box"

x-ros2-common-config: &ros2-common-config
  build:
    context: "$HOME/git/grand_tour_box/box_utils/box_auto/docker"
    dockerfile: "$HOME/git/grand_tour_box/box_utils/box_auto/docker/box_ros2.Dockerfile"
    ssh:
      default: "$HOME/.ssh/id_rsa_2"
  image: rslethz/grand_tour_box_ros2
  runtime: nvidia
  # network_mode: host
  privileged: true
  environment:
    QT_X11_NO_MITSHM: "1"
    XAUTHORITY: "/root/.docker.xauth"
    DISPLAY: "$DISPLAY"
    KLEINKRAM_ACTIVE: "False"  # Added this line
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities:
              - gpu
              - utility # nvidia-smi
              - compute # CUDA
              - video   # encoding 
  volumes:
    - "${MISSION_DATA:-/mission/data}:/mission_data"
    - "${GRAND_TOUR_BOX_PATH:-$HOME/git/grand_tour_box}:/home/catkin_ws/src/grand_tour_box"


services:
  # HDR _updated -> _calib 
  calibration:
    <<: *common-config
    container_name: calibration
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE; python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/calibration/update_calibration.py; exit $?"]


  # minimal AP20: _robot.bag - _synced.bag
  ap20_python_online_matcher:
    <<: *common-config
    container_name: ap20_python_online_matcher
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE; python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/ap20/ap20_python_online_matcher.py; exit $?"]

  # minimal AP20: _robot.bag
  ap20_validate:
    <<: *common-config
    container_name: ap20_validate
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE; python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/ap20/ap20_validate.py; exit $?"]
    depends_on:
      ap20_python_online_matcher:
        condition: service_completed_successfully

  # minimal hesai.bag -> hesai_post_processed.bag
  hesai:
    <<: *common-config
    container_name: hesai
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/lidar/hesai.py; exit $?"]
  
  # hesai_post_processed.bag & livox.bag -> hesai_filtered.bag , livox_filtered.bag
  filter_pointclouds: 
    <<: *common-config
    container_name: filter_pointclouds
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/lidar/filter_pointclouds.py; exit $?"]
    depends_on:
      hesai:
        condition: service_completed_successfully
        
  # minimal -> HDR _calib.bag _rect.bag  - ALPHA - .bag -> _rect.bag 
  rectify:
    <<: *common-config
    container_name: rectify
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/camera/rectify.py; exit $?"]
    depends_on:
      calibration:
        condition: service_completed_successfully

  # hesai.bag -> dlio.bag
  dlio:
    <<: *common-config
    container_name: dlio
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/application/dlio.py; exit $?"]
    depends_on:
      hesai:
        condition: service_completed_successfully
      calibration:
        condition: service_completed_successfully

  open3d_slam:
    <<: *common-config
    container_name: open3d_slam
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/application/open3d_slam.py; exit $?"]
    depends_on:
      hesai:
        condition: service_completed_successfully
      calibration:
        condition: service_completed_successfully
      dlio:
        condition: service_completed_successfully


  # this is needed for wavemap right now but should be replaced
  merge_dlio_tf_static:
    <<: *common-config
    container_name: merge_dlio_tf_static
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/general/merge_dlio_tf_static.py; exit $?"]
    depends_on:
      dlio:
        condition: service_completed_successfully
      calibration:
        condition: service_completed_successfully

  graph_msf:
    <<: *common-config
    container_name: graph_msf
    command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/application/graph_msf.py; exit $?"]
    depends_on:
      hesai:
        condition: service_completed_successfully
      calibration:
        condition: service_completed_successfully
      ap20_python_online_matcher:
        condition: service_completed_successfully

  # # hesai.bag -> dlio.bag
  # wavemap:
  #   <<: *common-config
  #   container_name: dlio
  #   command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/application/dlio.py; exit $?"]

  # color_correction:
  #   <<: *common-config
  #   container_name: color_correction
  #   command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/camera/color_correction.py; exit $?"]

  # topic_freq:
  #   <<: *common-config
  #   container_name: topic_freq
  #   command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/verification/topic_freq.py; exit $?"]

  #   depends_on:
  #     hesai:
  #       condition: service_completed_successfully
  #     cpt7:
  #       condition: service_completed_successfully
  #     ap20_python_online_matcher:
  #       condition: service_completed_successfully
  #     color_correction:
  #       condition: service_completed_successfully
  
  # cpt7:
  #   <<: *common-config
  #   container_name: cpt7
  #   command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/cpt7/cpt7.py; exit $?"]

  # imu_timesync:
  #   <<: *common-config
  #   container_name: imu_timesync
  #   command: ["sh", "-c", "export KLEINKRAM_ACTIVE=FALSE && python3 /home/catkin_ws/src/grand_tour_box/box_utils/box_auto/python/box_auto/scripts/verification/imu_timesync.py; exit $?"]
  #   depends_on:
  #     cpt7:
  #       condition: service_completed_successfully
  #     create_tf_static:
  #       condition: service_completed_successfully
  